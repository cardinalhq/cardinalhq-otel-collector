apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/name: cardinalhq
    app.kubernetes.io/component: collector
    app.kubernetes.io/instance: collector-gke-dev-dd
  name: cardinal-collector-config
data:
  config.yaml: |-
    receivers:
      chqdatadog:
        endpoint: 0.0.0.0:8126
    processors:
      batch:
        timeout: 10s
        send_batch_size: 10
        send_batch_max_size: 50
      memory_limiter:
        limit_mib: 1000
        check_interval: 1s
      attributes/ddremap:
        actions:
          - key: service
            action: upsert
            from_attribute: service.name
          - key: service.name
            action: delete
    exporters:
      debug:
        verbosity: detailed
      nop:
      datadog:
        api:
          key: ${env:DD_API_KEY}
          site: us3.datadoghq.com
      datadog/chq:
        api:
          key: ${env:DD_API_KEY}
          site: intake.cardinalhq.io
        logs:
          endpoint: https://intake.cardinalhq.io
        metrics:
          endpoint: https://intake.cardinalhq.io
        traces:
          endpoint: https://intake.cardinalhq.io
    connectors:
      forward/ddremap:

    service:
      pipelines:
        logs:
          receivers: [chqdatadog]
          processors: [memory_limiter, batch]
          exporters: [forward/ddremap, datadog/chq]
        logs/ddremap:
          receivers: [forward/ddremap]
          processors: [attributes/ddremap]
          exporters: [datadog, debug]
        metrics:
          receivers: [chqdatadog]
          exporters: [nop]
        traces:
          receivers: [chqdatadog]
          exporters: [nop]
      extensions:
        - zpages
        - health_check

      telemetry:
        metrics:
          readers:
            - periodic:
                interval: 10000
                exporter:
                  otlp:
                    protocol: grpc/protobuf
                    endpoint: http://cardinal-collector.collector.svc.cluster.local:4317

    extensions:
      zpages:
        endpoint: "0.0.0.0:55679"
      health_check:
        endpoint: "0.0.0.0:13133"
        path: "/healthz"
